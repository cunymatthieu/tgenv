#!/usr/bin/env bash

# Default values
tries=3
sleep_interval=5
stop_on_exit_code=""

# Function to display script usage
usage() {
  echo "Usage: $0 [options] <command>"
  echo "Options:"
  echo "  -sleep <seconds>           Sleep interval between tries (default: 5)"
  echo "  -tries <count>             Maximum number of tries (default: 3)"
  echo "  -stop-on-exit-code <code>  Exit loop if command returns the specified code"
  echo "  -help, -h                  Display this help message"
  exit 1
}

# Check if a command is provided
if [[ $# -eq 0 ]]; then
  usage
fi

# Parse command-line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -sleep)
      sleep_interval=$2
      shift 2
      ;;
    -tries)
      tries=$2
      shift 2
      ;;
    -stop-on-exit-code)
      stop_on_exit_code=$2
      shift 2
      ;;
    -help | -h)
      usage
      ;;
    *)
      break
      ;;
  esac
done

# Execute the command in a loop until success or maximum tries reached
counter=0
while [[ $counter -lt $tries ]]; do
  "$@"
  exit_code=$?

  if [[ $exit_code -eq 0 ]]; then
    exit 0
  elif [[ -n $stop_on_exit_code && $exit_code -eq $stop_on_exit_code ]]; then
    echo "Command returned specified exit code ($stop_on_exit_code). Won't retry, exiting."
    exit 1
  fi

  counter=$((counter + 1))

  if [[ $counter -lt $tries ]]; then
    echo "Attempt $counter failed. Retrying after $sleep_interval seconds..."
    sleep "$sleep_interval"
  fi
done

echo "Command failed after $tries attempts."
exit 1
